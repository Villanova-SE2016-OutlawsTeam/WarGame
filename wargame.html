<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>War Game</title>
	
    <link rel="stylesheet" href="wargame.css" type="text/css" />
</head>
<body>

<div id='war_game'>
    <header>
        <table>
            <tr>
                <td><h1>War Game</h1></td>
            </tr>
            <tr>
                <td><h1 id='playerMessage'></h1></td>
            </tr>

            <tr>
                <td><h1 id='roundWinner'></h1></td>
            </tr>

            <tr>
                <td><button id='playWholeRound' onclick="playWholeRound()">Play Whole Round</button> </td>
            </tr>
			<tr>
				<td><button id='proceedWhenTie' onclick="proceed()">Tie Breaker</button></td>
			</tr>
            <tr>
                <td><img onclick="dealDeck(event)" src="other_images/StartButton.png"></td>
            </tr>            
        </table>
    </header>

    
    <table>
    	<tr>
    		<th colspan=2 class="left" id="player1Score">Player 1</th>
            <th></th>		
            <th></th>
            <th></th>       
    		<th colspan=2 class="right" id="player2Score">Player 2</th>
    	</tr>

        <!-- The first row of cards -->
        <tr>
            <td>
                 <img id="player1" src="card_images/backface.png" class="backface">
            </td>
    		
    		<td id="battlefield1_secondary" class="secondary"><img src="card_images/backface.png" class="card_spacer"></td>
            <td id="battlefield1_primary" class="primary"><img src="card_images/backface.png" class="card_spacer"></td></td>
    		
    		<td id="nomansland"></td>
    		
    		<td id="battlefield2_primary" class="primary"><img src="card_images/backface.png" class="card_spacer"></td></td>
            <td id="battlefield2_secondary" class="secondary"><img src="card_images/backface.png" class="card_spacer"></td></td>

    		
            <td>
                <img id="player2" src="card_images/backface.png" class="backface">
            </td>
        </tr>   
    </table>

    <table id="tieTable">
          <tr>
            <td class="tie_player1">
                 <img id="player1_downcard1" src="card_images/backface.png" class="tie_backface">
            </td>
            
            <td class="tie_player1">
                 <img id="player1_downcard2" src="card_images/backface.png" class="tie_backface">
            </td>

            <td class="tie_player1">
                 <img id="player1_downcard3" src="card_images/backface.png" class="tie_backface">
            </td>
			
			<td id="player1_downcard4" class="tie_player1">
            </td>

            <td id="land" class="col3"></td>
			
			<td id="player2_downcard4" class="tie_player2">
            </td>
            
            <td class="tie_player2">
                 <img id="player2_downcard1" src="card_images/backface.png" class="tie_backface">
            </td>

             <td class="tie_player2">
                 <img id="player2_downcard2" src="card_images/backface.png" class="tie_backface">
            </td>

             <td class="tie_player2">
                 <img id="player2_downcard3" src="card_images/backface.png" class="tie_backface">
            </td>
        </tr>   
    </table>

</div>

<script src="Deck.js"></script>
<script src="GameConstants.js"></script>
<script src="Player.js"></script>
<script src="GameRound.js"></script>
<script type="text/javascript">

//Global vars
var imageTag = ""
var image_dir="card_images/"
var playerPlayed = ""
var winnerCards = []

var p1 = new Player(GameConstants.HUMAN, GameConstants.PLAYER1)
var p2 = new Player(GameConstants.COMPUTER, GameConstants.PLAYER2)

p1.deckElement = document.getElementById(p1.id);
p1.battleField_primary = document.getElementById("battlefield1_primary");
p1.battleField_secondary = document.getElementById("battlefield1_secondary");


p2.deckElement = document.getElementById(p2.id);
p2.battleField_primary = document.getElementById("battlefield2_primary");
p2.battleField_secondary = document.getElementById("battlefield2_secondary");


var playerMsgElement = document.getElementById(GameConstants.PLAYERMSG);
//Round Winner Element
var roundWinnerElement = document.getElementById(GameConstants.ROUNDWINNER);

// Display scores
var score1Element = document.getElementById(GameConstants.P1SCORE);
var score2Element = document.getElementById(GameConstants.P2SCORE);

var tieCardPlayer1 = document.getElementById("player1_downcard4");
var tieCardPlayer2 = document.getElementById("player2_downcard4");

//Assuming player1 starts for now.
var gameRound = new GameRound(p1.id, p1, p2); 

function dealDeck(event) {
    adjustPage(event);    

    starting_deck = new Deck()
	starting_deck.create_deck()
	starting_deck.shuffle()

	var deck_count = starting_deck.count()

	for (var i = 0; i < deck_count; i++) {
		card = starting_deck.pop()

		if (i % 2 == 0) {
			p1.active_deck.add(card)
		} else {
			p2.active_deck.add(card)
		}
	}

    updateClickListeners();
    updatePlayerMessage("Round: " + gameRound.count());
}

function adjustPage(event) {
    //removing the wargame image
    event.target.remove(); 

    //making the backfaces visible for each player
    backfaces = document.getElementsByClassName("backface")
    for (var i = 0; i < backfaces.length; i++) {
        thisCard = backfaces[i];
        thisCard.style.visibility = "visible"
    }

    document.getElementById("playWholeRound").style.visibility = "visible";
}

function updatePlayerMessage(msg) {
    playerMsgElement.innerHTML = msg;
}

function updateRoundWinner(msg) {
    roundWinnerElement.innerHTML = msg;
}

function updateScores() {
	score1Element.innerHTML = "Player 1 - " + p1.totalCardCount() + " cards";
	score2Element.innerHTML = "Player 2 - " + p2.totalCardCount() + " cards";
}

function showCard(card, destElem) {
    var card_img_file = image_dir + card.id + ".png";
    var imageTag = "<img src='" + card_img_file + "' class='card_regular' />";
    destElem.innerHTML = imageTag;
    destElem.style.visibility = "visible";
}

function showCardBackFace(destElem) {
    var card_img_file = "card_images/backface.png";
    var imageTag = "<img src='" + card_img_file + "' class='card_backface' />";
    destElem.innerHTML = imageTag;
    destElem.style.visibility = "visible";
}

function clearCardsFromBattleField() {
	// removes extra rows from tieTable if applicable
	while (document.getElementById("tieTable").rows.length > 1) {
		document.getElementById("tieTable").deleteRow(0);
	}
	
	tieCardPlayer1 = document.getElementById("player1_downcard4");
	tieCardPlayer2 = document.getElementById("player2_downcard4");
	
	backfaces = document.getElementsByClassName("tie_backface")
    for (var i = 0; i < backfaces.length; i++) {
        thisCard = backfaces[i];
        thisCard.style.visibility = "hidden"
    }
	
    p1.battleField_primary.innerHTML = "";
    p1.battleField_secondary.innerHTML = "";

    p2.battleField_primary.innerHTML = "";
    p2.battleField_secondary.innerHTML = "";

    tieCardPlayer1.innerHTML = "";
    tieCardPlayer2.innerHTML = "";
}

function updateClickListeners() {
    activePlayer = gameRound.getCurrentPlayer();
    otherPlayer = gameRound.getOtherPlayer();

    activePlayer.deckElement.addEventListener("click", cardClick);    
    otherPlayer.deckElement.removeEventListener("click", cardClick);
}

function playWholeRound() {
        console.log("Play Whole Round");
        player = gameRound.getCurrentPlayer();
        otherPlayer = gameRound.getOtherPlayer();

        d1_count = p1.totalCardCount();
        d2_count = p2.totalCardCount();

        function select_random_card() {
            options=["primary", "secondary"]
            low = 0;
            high = 1;
            chosen_index = Math.floor(Math.random()*(high - low+ 1 )+low);
            return options[chosen_index];
        }

        var card_min = GameConstants.MIN_CARDS_REQUIRED_PER_ROUND;

        if (player.id == GameConstants.PLAYER1) {
            if (d1_count >= card_min && d2_count >= card_min) {
                cardClick(select_random_card());
                cardClick(select_random_card());
                
            }
        } else {
            if (d2_count >= card_min) {
                cardClick(select_random_card());                    
            }            
        }           
}

function addRow() {
    console.log("add row");
/* Inserts a row into the tieTable */
	var table = document.getElementById("tieTable");
	var newRow = table.insertRow(0);
	
	// Create new cells for the row
	var cell1 = newRow.insertCell(0);
	var cell2 = newRow.insertCell(1);
	var cell3 = newRow.insertCell(2);
	var cell4 = newRow.insertCell(3);
	var cell5 = newRow.insertCell(4);
	var cell6 = newRow.insertCell(5);
	var cell7 = newRow.insertCell(6);
	var cell8 = newRow.insertCell(7);
	var cell9 = newRow.insertCell(8);
	
	// define classes for the new cells
	cell1.classList.add("tie_player1");
	cell2.classList.add("tie_player1");
	cell3.classList.add("tie_player1");
	cell4.classList.add("tie_player1");
	cell5.classList.add("col3");
	cell6.classList.add("tie_player2");
	cell7.classList.add("tie_player2");
	cell8.classList.add("tie_player2");
	cell9.classList.add("tie_player2");
	
	// define ids for the new cells
	cell4.id = 'player1_downcard4';
	cell5.id = 'land';
	cell6.id = 'player2_downcard4';
	
	// add content to new table cells
	cell1.innerHTML = '<img id="player1_downcard1" src="card_images/backface.png" class="tie_backface">'
	cell2.innerHTML = '<img id="player1_downcard2" src="card_images/backface.png" class="tie_backface">'
	cell3.innerHTML = '<img id="player1_downcard3" src="card_images/backface.png" class="tie_backface">'
	cell4.innerHTML = ''
	cell5.innerHTML = ''
	cell6.innerHTML = ''
	cell7.innerHTML = '<img id="player2_downcard1" src="card_images/backface.png" class="tie_backface">'
	cell8.innerHTML = '<img id="player2_downcard2" src="card_images/backface.png" class="tie_backface">'
	cell9.innerHTML = '<img id="player2_downcard3" src="card_images/backface.png" class="tie_backface">'
	
	// new location for the face up cards
	tieCardPlayer1 = document.getElementById("tieTable").getElementsByTagName('tr')[0].getElementsByTagName('td')[3];
	tieCardPlayer2 = document.getElementById("tieTable").getElementsByTagName('tr')[0].getElementsByTagName('td')[5];
}

var tieBreaker = function() {
    console.log("tie breaker")
	Winner = null; 
	Loser = null;
	gameOver = false;
	
    //display faced down cards when tie
    backfaces = document.getElementsByClassName("tie_backface")
    for (var i = 0; i < backfaces.length; i++) {
        thisCard = backfaces[i];
        thisCard.style.visibility = "visible"
    }
	
    //add war cards to winning card array
    for (var j = 0; j < 4; j++) {
        p1.activeCard = p1.nextCardFromDeck();
		p2.activeCard = p2.nextCardFromDeck();
        winnerCards.push(p1.activeCard);
		winnerCards.push(p2.activeCard);
    }

	// display face up cards
    showCard(p1.activeCard, tieCardPlayer1);
    showCard(p2.activeCard, tieCardPlayer2);
	
	// handle nested ties
	if (p1.activeCard.value == p2.activeCard.value) {
		updateRoundWinner("Tie!");
		console.log("Tie!");
		
		if (!LessThan4Cards()) {
			addRow();
			tieBreaker();
		} else {
			gameOver = true;
			Winner = (p1.active_deck.count() + p1.discarded_deck.count() > p2.active_deck.count() + p2.discarded_deck.count()) ? p1 : p2;
			Loser = (Winner === p1) ? p2 : p1;
		}
	} else {
		Winner = (p1.activeCard.value > p2.activeCard.value) ? p1 : p2;
		Loser = (Winner === p1) ? p2 : p1;
		
		for(var i=0; i<winnerCards.length; i++){
        console.log(winnerCards[i].value);
		}
	}
	
	document.getElementById("playWholeRound").style.visibility = "visible";
	return {
		Winner: Winner,
		Loser: Loser,
		gameOver: gameOver
	}

}

// determines if one of the players has less than 4 cards left
function LessThan4Cards() {
    // console.log("less than four");
	var gameOver = false;
	
	if ((p1.discarded_deck.count() + p1.active_deck.count() < 4)  || (p2.discarded_deck.count() + p2.active_deck.count() < 4)) {
		gameOver = true;
	}
	
	return gameOver;
}

// determines if one of the players is out of cards
function OutOfCards() {
    // console.log("out of cards");
	var gameOver = false; 
	
	if (gameRound.bothPlayedCard) {
		if ((p1.discarded_deck.count() + p1.active_deck.count() == 0) || (p2.discarded_deck.count() + p2.active_deck.count() == 0)) {
			gameOver = true;
		}
	}
	return gameOver;
}

function deck_info() {
    var total = p1.totalCardCount() + p2.totalCardCount();

    console.log("(" + p1.active_deck.count() + "," + p1.discarded_deck.count() + ")" + 
        " + " + 
        "(" + p2.active_deck.count() + "," + p2.discarded_deck.count() + ")" + " = " + total);    
}

function cardClick(optional_card_choice) {
	deck_info();

    var player = gameRound.getCurrentPlayer();

    if (gameRound.isNewRound) {
        updatePlayerMessage("Round: " + gameRound.count());
        p1.activeCard = null;
        p2.activeCard = null;
        clearCardsFromBattleField();
    }
    
    if (player.totalCardCount() > 0) {
        var card = player.nextCardFromDeck();

		if (player.totalCardCount() == 0) {
		  player.deckElement.style.visibility = "hidden";
		}  
        player.activeCard = card;

        showCardBackFace(player.battleField_secondary)
        showCard(card, player.battleField_primary);

        //Turn off the usual listener, and turn on listener to decide on which card to use
        player.deckElement.removeEventListener("click", cardClick);
        player.battleField_primary.addEventListener("click", cardClick_decideOnCardToPlay);
        player.battleField_secondary.addEventListener("click", cardClick_decideOnCardToPlay);

    //this is for the 'play whole round' button
    if (typeof optional_card_choice != "object") {
        cardClick_Continued(optional_card_choice);
    }
}

function cardClick_decideOnCardToPlay(event) {    
    if (event.target.className == "card_backface") {
        cardClick_Continued("secondary");       
    } else {
        cardClick_Continued("primary");       
    }
}

function cardClick_Continued(chosen_card) {
        player = gameRound.getCurrentPlayer();

        if (chosen_card == "secondary") {
            player.discarded_deck.add(player.activeCard);   

            //grab a new card
            var card = player.nextCardFromDeck();
            player.activeCard = card;
            
            if (player.totalCardCount() == 0) {
              player.deckElement.style.visibility = "hidden";
            }  
            
            // player.battleField_primary.style.visibility = "hidden";
            showCard(card, player.battleField_secondary);
            showCardBackFace(player.battleField_primary)
        } else {
            var card = player.nextCardFromDeck();
            player.discarded_deck.add(card);        //add unplayed card to discarded deck

                    
        }

        //remove listeners before continuing the round
        player.battleField_primary.removeEventListener("click", cardClick_decideOnCardToPlay);
        player.battleField_secondary.removeEventListener("click", cardClick_decideOnCardToPlay);

        var player = gameRound.getCurrentPlayer();
        var winner = null;
        var loser = null;
        var gameOver = false;

        player.playedTurn = true;

        if (gameRound.bothPlayedCard()) {   
            // handles tie condition
            if (gameRound.isTie()) {
                updateRoundWinner("Tie!");
                console.log("Tie!");
                
                if (!LessThan4Cards()) {
                    console.log("found less than four cards!!!")
                    // game over
                    document.getElementById("playWholeRound").style.visibility = "hidden";
                    tie = new tieBreaker();
                    winner = tie.Winner;
                    loser = tie.Loser;
                    gameOver = tie.gameOver;
                } else {
                    // proceed to handle tie
                    winner = (p1.active_deck.count() + p1.discarded_deck.count() > p2.active_deck.count() + p2.discarded_deck.count()) ? p1 : p2;
                    loser = (winner === p1) ? p2 : p1;
                    gameOver = true;
                }
            
                //you can only win multiple cards if you win a tie
                while(winnerCards.length > 0) {
                    wonCard = winnerCards.pop();
                    winner.discarded_deck.add(wonCard);
                }

            } else {
                winner = gameRound.whoWon();
                loser = gameRound.whoLost();

                winner.discarded_deck.add(winner.activeCard);
                winner.discarded_deck.add(loser.activeCard);
            }
            
            updateRoundWinner("Winner: " + winner.id);
            console.log("Round " + gameRound.count() + ": Winner: " + winner.id + ", Loser: " + loser.id);
            
            
            if (OutOfCards()) {
                gameOver = true;
            }
            
            console.log(p1.id + " Count Active Deck: " + p1.active_deck.count());
            console.log(p1.id + " Count Discard Deck: " + p1.discarded_deck.count());
            
            console.log(p2.id + " Count Active Deck: " + p2.active_deck.count());
            console.log(p2.id + " Count Discard Deck: " + p2.discarded_deck.count());
            updateScores();
            
            if (gameOver) {
                if (loser.active_deck.count() == 0) {
                    loser.deckElement.style.visibility = "hidden";
                }
                document.getElementById("playWholeRound").style.visibility = "hidden";
                updatePlayerMessage("GAME OVER!");
                return;
            }

        } 
        
        deck_info();
        gameRound.nextTurn();      
        updateClickListeners(); 
    } 
}

</script>

</body>
</html>