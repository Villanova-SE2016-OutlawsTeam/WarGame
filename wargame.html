<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>War Game</title>
	
    <link rel="stylesheet" href="wargame.css" type="text/css" />
</head>
<body>

<div id='war_game'>
    <header>
        <table>
            <tr>
                <td><h1>War Game</h1></td>
            </tr>
            <tr>
                <td><h1 id='playerMessage'></h1></td>
            </tr>

            <tr>
                <td><h1 id='roundWinner'></h1></td>
            </tr>

            <tr>
                <td><button id='playWholeRound' onclick="playWholeRound()">Play Whole Round</button> </td>
                <td><button id='proceedWhenTie' onclick="proceed()">Proceed</button></td>
            </tr>
            <tr>
                <td><img onclick="dealDeck(event)" src="other_images/StartButton.png"></td>
            </tr>            
        </table>
    </header>

    <table>
    	<tr>
    		<th colspan=2 class="left">Player 1</th>
            <th></th>		
            <th></th>       
    		<th colspan=2 class="right">Player 2</th>
    	</tr>

        <tr>
            <td class="col1">
                 <img id="player1" src="card_images/backface.png" class="backface">
            </td>
    		
    		<td id="battlefield1" class="col2"></td>
    		
    		<td id="nomansland" class="col3"></td>
    		
    		<td><td id="battlefield2" class="col4"></td>
    		
            <td class="col5">
                <img id="player2" src="card_images/backface.png" class="backface">
            </td>
        </tr>   
    </table>

    <table>
          <tr>
            <td class="tie_player1">
                 <img id="player1_downcard1" src="card_images/backface.png" class="tie_backface">
            </td>
            
            <td class="tie_player1">
                 <img id="player1_downcard2" src="card_images/backface.png" class="tie_backface">
            </td>

            <td class="tie_player1">
                 <img id="player1_downcard3" src="card_images/backface.png" class="tie_backface">
            </td>

            <td id="land" class="col3"></td>
            
            <td class="tie_player2">
                 <img id="player2_downcard1" src="card_images/backface.png" class="tie_backface">
            </td>

             <td class="tie_player2">
                 <img id="player2_downcard2" src="card_images/backface.png" class="tie_backface">
            </td>

             <td class="tie_player2">
                 <img id="player2_downcard3" src="card_images/backface.png" class="tie_backface">
            </td>
        </tr>   
    </table>

    <table>
        <tr>
            <td id="player1_downcard4" class="col2"></td>

            <td id="land" class="col3"></td>

            <td id="player2_downcard4" class="col4"></td>
    </table>
</div>

<script src="Deck.js"></script>
<script src="GameConstants.js"></script>
<script src="Player.js"></script>
<script src="GameRound.js"></script>
<script type="text/javascript">

//Global vars
var imageTag = ""
var image_dir="card_images/"
var playerPlayed = ""
var winnerCards = []

var p1 = new Player(GameConstants.HUMAN, GameConstants.PLAYER1)
var p2 = new Player(GameConstants.COMPUTER, GameConstants.PLAYER2)

p1.deckElement = document.getElementById(p1.id);
p1.battleField = document.getElementById(GameConstants.BATTLEFIELD1);

p2.deckElement = document.getElementById(p2.id);
p2.battleField = document.getElementById(GameConstants.BATTLEFIELD2);

var playerMsgElement = document.getElementById(GameConstants.PLAYERMSG);
//Round Winner Element
var roundWinnerElement = document.getElementById(GameConstants.ROUNDWINNER);

var tieCardPlayer1 = document.getElementById("player1_downcard4");
var tieCardPlayer2 = document.getElementById("player2_downcard4");

//Assuming player1 starts for now.
var gameRound = new GameRound(p1.id, p1, p2); 

function dealDeck(event) {
    adjustPage(event);    

    starting_deck = new Deck()
	starting_deck.create_deck()
	starting_deck.shuffle()

	var deck_count = starting_deck.count()

	for (var i = 0; i < deck_count; i++) {
		card = starting_deck.pop()

		if (i % 2 == 0) {
			p1.active_deck.add(card)
		} else {
			p2.active_deck.add(card)
		}
	}

    updateClickListeners();
    updatePlayerMessage("Round: " + gameRound.count());
}

function adjustPage(event) {
    //removing the wargame image
    event.target.remove(); 

    //making the backfaces visible for each player
    backfaces = document.getElementsByClassName("backface")
    for (var i = 0; i < backfaces.length; i++) {
        thisCard = backfaces[i];
        thisCard.style.visibility = "visible"
    }

    document.getElementById("playWholeRound").style.visibility = "visible";
}

function updatePlayerMessage(msg) {
    playerMsgElement.innerHTML = msg;
}

function updateRoundWinner(msg) {
    roundWinnerElement.innerHTML = msg;
}

function showCard(card, destElem) {
    var card_img_file = image_dir + card.id + ".png";
    var imageTag = "<img src='" + card_img_file + "' />";
    destElem.innerHTML = imageTag;
}

function clearCardsFromBattleField() {
	backfaces = document.getElementsByClassName("tie_backface")
    for (var i = 0; i < backfaces.length; i++) {
        thisCard = backfaces[i];
        thisCard.style.visibility = "hidden"
    }
	
    p1.battleField.innerHTML = "";
    p2.battleField.innerHTML = "";

    tieCardPlayer1.innerHTML = "";
    tieCardPlayer2.innerHTML = "";
}

function updateClickListeners() {
    activePlayer = gameRound.getCurrentPlayer();
    otherPlayer = gameRound.getOtherPlayer();

    activePlayer.deckElement.addEventListener("click", cardClick);    
    otherPlayer.deckElement.removeEventListener("click", cardClick);
}

function playWholeRound() {
        player = gameRound.getCurrentPlayer();
        otherPlayer = gameRound.getOtherPlayer();

        d1_count = p1.active_deck.count();
        d2_count = p2.active_deck.count();

        if (player.id == GameConstants.PLAYER1) {
            if (d1_count > 0 && d2_count > 0) {
                cardClick();
                cardClick();
            }
        } else {
            if (d2_count > 0) {
                cardClick();    
            }            
        }           
}

function proceed(){
    document.getElementById("proceedWhenTie").style.visibility = "hidden";
    //display faced down cards when tie
    backfaces = document.getElementsByClassName("tie_backface")
    for (var i = 0; i < backfaces.length; i++) {
        thisCard = backfaces[i];
        thisCard.style.visibility = "visible"
    }

    //add war cards to winning card array
    for (var j = 0; j < 4; j++) {
        if (p1.active_deck.count() > 4) {
            warCard = p1.active_deck.pop();
            winnerCards.push(warCard);
        }
        
        if (p2.active_deck.count() > 4) {
            warCard = p2.active_deck.pop();
            winnerCards.push(warCard);
        }
    }

    for(var i=0; i<winnerCards.length; i++){
        console.log(winnerCards[i].value);
    }

    showCard(winnerCards[5], tieCardPlayer1);
    showCard(winnerCards[9], tieCardPlayer2);

    if(winnerCards[5].value > winnerCards[9].value){
        var winner = p1;
        console.log("Winner: " + winner.id);
        updateRoundWinner("Winner: " + winner.id);
    }else{
        var winner = p2;
        console.log("Winner: " + winner.id);
        updateRoundWinner("Winner: " + winner.id);
    }


}

function cardClick() {
	
    if (gameRound.isNewRound) {
        updatePlayerMessage("Round: " + gameRound.count());
        p1.activeCard = null;
        p2.activeCard = null;
        clearCardsFromBattleField();
        document.getElementById("proceedWhenTie").style.visibility = "hidden";
    }
	
	console.log(p1.id + " Count Active Deck: " + p1.active_deck.count());
	console.log(p1.id + " Count Discard Deck: " + p1.discarded_deck.count());
	console.log(p2.id + " Count Active Deck: " + p2.active_deck.count());
	console.log(p2.id + " Count Discard Deck: " + p2.discarded_deck.count());
	
    var player = gameRound.getCurrentPlayer();
    
    if (player.active_deck.count() > 0) {
        var card = player.active_deck.pop();
		if (player.active_deck.count() == 0) {
		  player.deckElement.style.visibility = "hidden";
		}  
        player.activeCard = card;
        showCard(card, player.battleField);
        player.playedTurn = true;
		winnerCards.push(player.activeCard);

        if (gameRound.bothPlayedCard()) {
            if (gameRound.isTie()) {
                 updateRoundWinner("Tie!");
                 document.getElementById("proceedWhenTie").style.visibility = "visible";
            } else {
                var winner = gameRound.whoWon();
                updateRoundWinner("Winner: " + winner.id);
                var loser = gameRound.whoLost();
                console.log("Round " + gameRound.count() + ": Winner: " + winner.id + ", Loser: " + loser.id);
				
				// add cards to winner's discard deck
				while(winnerCards.length) {
				    wonCard = winnerCards.pop();
                    winner.discarded_deck.add(wonCard);
				}
				
            }
			
			if ((p1.discarded_deck.count() == 0 && p1.active_deck == 0) || (p2.discarded_deck.count() == 0 && p2.active_deck.count() == 0)) {
				updatePlayerMessage("GAME OVER! " + winner.id + " wins!");
			}

			if (p1.active_deck.count() == 0) {
				p1.discarded_deck.shuffle();
				p1.deckElement.style.visibility = "visible";
				
				while (p1.discarded_deck.count() > 0) {
					card = p1.discarded_deck.pop();
					p1.active_deck.add(card);
				}
			}
			
			if (p2.active_deck.count() == 0) {
				p2.discarded_deck.shuffle();
				p2.deckElement.style.visibility = "visible";
				
				while (p2.discarded_deck.count() > 0) {
					card = p2.discarded_deck.pop();
					p2.active_deck.add(card);
				}
			}
        }
		
		gameRound.nextTurn();      
		updateClickListeners(); 
           
    } 

}

</script>

</body>
</html>