<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>War Game</title>
	
    <link rel="stylesheet" href="wargame.css" type="text/css" />
</head>
<body>

<div id='war_game'>
    <header>
        <table>
            <tr>
                <td><h1>War Game</h1></td>
            </tr>
            <tr>
                <td><h1 id='playerMessage'></h1></td>
            </tr>

            <tr>
                <td><h1 id='roundWinner'></h1></td>
            </tr>

            <tr>
                <td><button id='playWholeRound' onclick="playWholeRound()">Play Whole Round</button> </td>
            </tr>
			<tr>
				<td><button id='proceedWhenTie' onclick="proceed()">Tie Breaker</button></td>
			</tr>
            <tr>
                <td><img onclick="dealDeck(event)" src="other_images/StartButton.png"></td>
            </tr>            
        </table>
    </header>

    <table>
    	<tr>
    		<th colspan=2 class="left" id="player1Score">Player 1</th>
            <th></th>		
            <th></th>       
    		<th colspan=2 class="right" id="player2Score">Player 2</th>
    	</tr>

        <tr>
            <td class="col1">
                 <img id="player1" src="card_images/backface.png" class="backface">
            </td>
    		
    		<td id="battlefield1" class="col2"></td>
    		
    		<td id="nomansland" class="col3"></td>
    		
    		<td><td id="battlefield2" class="col4"></td>
    		
            <td class="col5">
                <img id="player2" src="card_images/backface.png" class="backface">
            </td>
        </tr>   
    </table>

    <table id="tieTable">
          <tr>
            <td class="tie_player1">
                 <img id="player1_downcard1" src="card_images/backface.png" class="tie_backface">
            </td>
            
            <td class="tie_player1">
                 <img id="player1_downcard2" src="card_images/backface.png" class="tie_backface">
            </td>

            <td class="tie_player1">
                 <img id="player1_downcard3" src="card_images/backface.png" class="tie_backface">
            </td>
			
			<td id="player1_downcard4" class="tie_player1">
            </td>

            <td id="land" class="col3"></td>
			
			<td id="player2_downcard4" class="tie_player2">
            </td>
            
            <td class="tie_player2">
                 <img id="player2_downcard1" src="card_images/backface.png" class="tie_backface">
            </td>

             <td class="tie_player2">
                 <img id="player2_downcard2" src="card_images/backface.png" class="tie_backface">
            </td>

             <td class="tie_player2">
                 <img id="player2_downcard3" src="card_images/backface.png" class="tie_backface">
            </td>
        </tr>   
    </table>

</div>

<script src="Deck.js"></script>
<script src="GameConstants.js"></script>
<script src="Player.js"></script>
<script src="GameRound.js"></script>
<script type="text/javascript">

//Global vars
var imageTag = ""
var image_dir="card_images/"
var playerPlayed = ""
var winnerCards = []

var p1 = new Player(GameConstants.HUMAN, GameConstants.PLAYER1)
var p2 = new Player(GameConstants.COMPUTER, GameConstants.PLAYER2)

p1.deckElement = document.getElementById(p1.id);
p1.battleField = document.getElementById(GameConstants.BATTLEFIELD1);

p2.deckElement = document.getElementById(p2.id);
p2.battleField = document.getElementById(GameConstants.BATTLEFIELD2);

var playerMsgElement = document.getElementById(GameConstants.PLAYERMSG);
//Round Winner Element
var roundWinnerElement = document.getElementById(GameConstants.ROUNDWINNER);

// Display scores
var score1Element = document.getElementById(GameConstants.P1SCORE);
var score2Element = document.getElementById(GameConstants.P2SCORE);

var tieCardPlayer1 = document.getElementById("player1_downcard4");
var tieCardPlayer2 = document.getElementById("player2_downcard4");

//Assuming player1 starts for now.
var gameRound = new GameRound(p1.id, p1, p2); 

function dealDeck(event) {
    adjustPage(event);    

    starting_deck = new Deck()
	starting_deck.create_deck()
	starting_deck.shuffle()

	var deck_count = starting_deck.count()

	for (var i = 0; i < deck_count; i++) {
		card = starting_deck.pop()

		if (i % 2 == 0) {
			p1.active_deck.add(card)
		} else {
			p2.active_deck.add(card)
		}
	}

    updateClickListeners();
    updatePlayerMessage("Round: " + gameRound.count());
}

function adjustPage(event) {
    //removing the wargame image
    event.target.remove(); 

    //making the backfaces visible for each player
    backfaces = document.getElementsByClassName("backface")
    for (var i = 0; i < backfaces.length; i++) {
        thisCard = backfaces[i];
        thisCard.style.visibility = "visible"
    }

    document.getElementById("playWholeRound").style.visibility = "visible";
}

function updatePlayerMessage(msg) {
    playerMsgElement.innerHTML = msg;
}

function updateRoundWinner(msg) {
    roundWinnerElement.innerHTML = msg;
}

function updateScores() {
	score1Element.innerHTML = "Player 1 - " + (p1.active_deck.count() + p1.discarded_deck.count()) + " cards";
	score2Element.innerHTML = "Player 2 - " + (p2.active_deck.count() + p2.discarded_deck.count()) + " cards";
}

function showCard(card, destElem) {
    var card_img_file = image_dir + card.id + ".png";
    var imageTag = "<img src='" + card_img_file + "' />";
    destElem.innerHTML = imageTag;
}

function clearCardsFromBattleField() {
	// removes extra rows from tieTable if applicable
	while (document.getElementById("tieTable").rows.length > 1) {
		document.getElementById("tieTable").deleteRow(0);
	}
	
	tieCardPlayer1 = document.getElementById("player1_downcard4");
	tieCardPlayer2 = document.getElementById("player2_downcard4");
	
	backfaces = document.getElementsByClassName("tie_backface")
    for (var i = 0; i < backfaces.length; i++) {
        thisCard = backfaces[i];
        thisCard.style.visibility = "hidden"
    }
	
    p1.battleField.innerHTML = "";
    p2.battleField.innerHTML = "";

    tieCardPlayer1.innerHTML = "";
    tieCardPlayer2.innerHTML = "";
}

function updateClickListeners() {
    activePlayer = gameRound.getCurrentPlayer();
    otherPlayer = gameRound.getOtherPlayer();

    activePlayer.deckElement.addEventListener("click", cardClick);    
    otherPlayer.deckElement.removeEventListener("click", cardClick);
}

function playWholeRound() {
        player = gameRound.getCurrentPlayer();
        otherPlayer = gameRound.getOtherPlayer();

        d1_count = p1.active_deck.count();
        d2_count = p2.active_deck.count();

        if (player.id == GameConstants.PLAYER1) {
            if (d1_count > 0 && d2_count > 0) {
                cardClick();
                cardClick();
            }
        } else {
            if (d2_count > 0) {
                cardClick();    
            }            
        }           
}

function addRow() {
/* Inserts a row into the tieTable */
	var table = document.getElementById("tieTable");
	var newRow = table.insertRow(0);
	
	// Create new cells for the row
	var cell1 = newRow.insertCell(0);
	var cell2 = newRow.insertCell(1);
	var cell3 = newRow.insertCell(2);
	var cell4 = newRow.insertCell(3);
	var cell5 = newRow.insertCell(4);
	var cell6 = newRow.insertCell(5);
	var cell7 = newRow.insertCell(6);
	var cell8 = newRow.insertCell(7);
	var cell9 = newRow.insertCell(8);
	
	// define classes for the new cells
	cell1.classList.add("tie_player1");
	cell2.classList.add("tie_player1");
	cell3.classList.add("tie_player1");
	cell4.classList.add("tie_player1");
	cell5.classList.add("col3");
	cell6.classList.add("tie_player2");
	cell7.classList.add("tie_player2");
	cell8.classList.add("tie_player2");
	cell9.classList.add("tie_player2");
	
	// define ids for the new cells
	cell4.id = 'player1_downcard4';
	cell5.id = 'land';
	cell6.id = 'player2_downcard4';
	
	// add content to new table cells
	cell1.innerHTML = '<img id="player1_downcard1" src="card_images/backface.png" class="tie_backface">'
	cell2.innerHTML = '<img id="player1_downcard2" src="card_images/backface.png" class="tie_backface">'
	cell3.innerHTML = '<img id="player1_downcard3" src="card_images/backface.png" class="tie_backface">'
	cell4.innerHTML = ''
	cell5.innerHTML = ''
	cell6.innerHTML = ''
	cell7.innerHTML = '<img id="player2_downcard1" src="card_images/backface.png" class="tie_backface">'
	cell8.innerHTML = '<img id="player2_downcard2" src="card_images/backface.png" class="tie_backface">'
	cell9.innerHTML = '<img id="player2_downcard3" src="card_images/backface.png" class="tie_backface">'
	
	// new location for the face up cards
	tieCardPlayer1 = document.getElementById("tieTable").getElementsByTagName('tr')[0].getElementsByTagName('td')[3];
	tieCardPlayer2 = document.getElementById("tieTable").getElementsByTagName('tr')[0].getElementsByTagName('td')[5];
}

var tieBreaker = function() {
	Winner = null; 
	Loser = null;
	gameOver = false;
	
    //display faced down cards when tie
    backfaces = document.getElementsByClassName("tie_backface")
    for (var i = 0; i < backfaces.length; i++) {
        thisCard = backfaces[i];
        thisCard.style.visibility = "visible"
    }
	
    //add war cards to winning card array
    for (var j = 0; j < 4; j++) {
		swapDecks();
        p1.activeCard = p1.active_deck.pop();
		p2.activeCard = p2.active_deck.pop();
        winnerCards.push(p1.activeCard);
		winnerCards.push(p2.activeCard);
    }

	// display face up cards
    showCard(p1.activeCard, tieCardPlayer1);
    showCard(p2.activeCard, tieCardPlayer2);
	
	// handle nested ties
	if (p1.activeCard.value == p2.activeCard.value) {
		updateRoundWinner("Tie!");
		console.log("Tie!");
		
		if (!LessThan4Cards()) {
			addRow();
			tieBreaker();
		} else {
			gameOver = true;
			Winner = (p1.active_deck.count() + p1.discarded_deck.count() > p2.active_deck.count() + p2.discarded_deck.count()) ? p1 : p2;
			Loser = (Winner === p1) ? p2 : p1;
		}
	} else {
		Winner = (p1.activeCard.value > p2.activeCard.value) ? p1 : p2;
		Loser = (Winner === p1) ? p2 : p1;
		
		for(var i=0; i<winnerCards.length; i++){
        console.log(winnerCards[i].value);
		}
	}
	
	document.getElementById("playWholeRound").style.visibility = "visible";
	return {
		Winner: Winner,
		Loser: Loser,
		gameOver: gameOver
	}

}

// Moves discarded_deck to active_deck if active_deck is empty
function swapDecks() {
	if (p1.active_deck.count() == 0) {
		p1.discarded_deck.shuffle();
		p1.deckElement.style.visibility = "visible";
				
		while (p1.discarded_deck.count() > 0) {
			card = p1.discarded_deck.pop();
			p1.active_deck.add(card);
		}
	}
			
	if (p2.active_deck.count() == 0) {
		p2.discarded_deck.shuffle();
		p2.deckElement.style.visibility = "visible";
				
		while (p2.discarded_deck.count() > 0) {
			card = p2.discarded_deck.pop();
			p2.active_deck.add(card);
		}
	}
}

// determines if one of the players has less than 4 cards left
function LessThan4Cards() {
	var gameOver = false;
	
	if ((p1.discarded_deck.count() + p1.active_deck.count() < 4)  || (p2.discarded_deck.count() + p2.active_deck.count() < 4)) {
		gameOver = true;
	}
	
	return gameOver;
}

// determines if one of the players is out of cards
function OutOfCards() {
	var gameOver = false; 
	
	if (gameRound.bothPlayedCard) {
		if ((p1.discarded_deck.count() + p1.active_deck.count() == 0) || (p2.discarded_deck.count() + p2.active_deck.count() == 0)) {
			gameOver = true;
		}
	}
	return gameOver;
}

function cardClick() {
	
    if (gameRound.isNewRound) {
        updatePlayerMessage("Round: " + gameRound.count());
        p1.activeCard = null;
        p2.activeCard = null;
        clearCardsFromBattleField();
    }
	
    var player = gameRound.getCurrentPlayer();
	var winner = null;
	var loser = null;
	var gameOver = false;
    
    if (player.active_deck.count() > 0) {
        var card = player.active_deck.pop();
		if (player.active_deck.count() == 0) {
		  player.deckElement.style.visibility = "hidden";
		}  
        player.activeCard = card;
        showCard(card, player.battleField);
        player.playedTurn = true;
		winnerCards.push(player.activeCard);

        if (gameRound.bothPlayedCard()) {	
			// handles tie condition
            if (gameRound.isTie()) {
				updateRoundWinner("Tie!");
				console.log("Tie!");
				
				if (!LessThan4Cards()) {
					// game over
					document.getElementById("playWholeRound").style.visibility = "hidden";
					tie = new tieBreaker();
					winner = tie.Winner;
					loser = tie.Loser;
					gameOver = tie.gameOver;
				} else {
					// proceed to handle tie
					winner = (p1.active_deck.count() + p1.discarded_deck.count() > p2.active_deck.count() + p2.discarded_deck.count()) ? p1 : p2;
					loser = (winner === p1) ? p2 : p1;
					gameOver = true;
				}
            } else {
                winner = gameRound.whoWon();
				loser = gameRound.whoLost();
            }
			
			updateRoundWinner("Winner: " + winner.id);
            console.log("Round " + gameRound.count() + ": Winner: " + winner.id + ", Loser: " + loser.id);
				
			// add cards to winner's discard deck
			while(winnerCards.length) {
				wonCard = winnerCards.pop();
                winner.discarded_deck.add(wonCard);
			}
			
			if (OutOfCards()) {
				gameOver = true;
			}
			
			console.log(p1.id + " Count Active Deck: " + p1.active_deck.count());
			console.log(p1.id + " Count Discard Deck: " + p1.discarded_deck.count());
			console.log(p2.id + " Count Active Deck: " + p2.active_deck.count());
			console.log(p2.id + " Count Discard Deck: " + p2.discarded_deck.count());
			updateScores();
			
			if (gameOver) {
				if (loser.active_deck.count() == 0) {
					loser.deckElement.style.visibility = "hidden";
				}
				document.getElementById("playWholeRound").style.visibility = "hidden";
				updatePlayerMessage("GAME OVER!");
				return;
			}

			swapDecks();
        } 
		
		gameRound.nextTurn();      
		updateClickListeners(); 
           
    } 

}

</script>

</body>
</html>